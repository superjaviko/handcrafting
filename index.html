<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
  <title>HUMANMADE+</title>

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: 'Playfair Display', serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .header { text-align: center; margin-bottom: 20px; }
    .logo { max-width: 180px; width: 80%; height: auto; margin-bottom: 10px; }

    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 15px; /* Espaciado constante entre bloques */
    }

    h1 { font-weight: 600; text-align: center; margin: 0; }
    .intro-text { text-align: justify; line-height: 1.4; margin: 0; }
    .menu-text { text-align: center; margin: 5px 0; font-style: italic; }

    /* BOTONES */
    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .action-btn {
      width: 100%;
      padding: 15px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, #888888, #555555);
      color: #fff;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .action-btn:active { transform: scale(0.98); }
    .action-btn.active { 
        background: linear-gradient(135deg, #ff416c, #ff4b2b); 
        box-shadow: 0 4px 10px rgba(255, 65, 108, 0.3);
    }

    .btn-chat { background: linear-gradient(135deg, #c39bd3, #a569bd); }
    .btn-voice { background: linear-gradient(135deg, #6c3483, #4a235a); }

    /* SECCIONES DIN√ÅMICAS (Soluci√≥n a la superposici√≥n) */
    .layout-wrapper {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
    }

    #contenidoObjeto, #respuestaChat {
      padding: 16px;
      background: #fdfdfd;
      border-radius: 12px;
      font-size: 15px;
      text-align: justify;
      line-height: 1.5;
      /* EFECTO NEGRO SOLICITADO */
      box-shadow: inset 0 0 0 1px #000000; 
      border-left: 6px solid #8e44ad;
      min-height: 40px;
    }

    .chat-box {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }

    .chat-box input {
      width: 100%;
      padding: 14px;
      font-size: 16px; /* Evita zoom en iOS */
      border-radius: 8px;
      border: 1px solid #ccc;
      font-family: inherit;
    }

    #btnInvia {
      width: 100%;
      padding: 14px;
      background: #222;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    .hidden { display: none !important; }

    .fade-in { animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .footer { margin-top: 30px; text-align: center; }
    .footer-logo { max-width: 120px; width: 35%; opacity: 0.8; }
  </style>
</head>

<body>

  <div class="header">
    <img src="logo.png" alt="Logo" class="logo">
  </div>

  <div class="container">
    <h1>Umanit√† Intrecciate</h1>

    <p class="intro-text">
      Questo oggetto ha una storia speciale. Seleziona un'opzione per saperne di pi√π.
    </p>

    <div class="actions">
      <button class="action-btn btn-voice" onclick="iniciarVoz(this)">üé§ Chiedimi qualcosa</button>
      <p class="menu-text">Oppure</p>
      <button class="action-btn btn-chat" onclick="mostrarChat(this)">ü§ñ Chiedi all'IA</button>
      <button class="action-btn" onclick="mostrarProceso(this)">üìú Processo di Creazione</button>
      <button class="action-btn" onclick="mostrarSignificado(this)">üé® Significato</button>
      <button class="action-btn" onclick="mostrarTecnica(this)">üõ†Ô∏è Tecniche utilizzate</button>
    </div>

    <div class="layout-wrapper">
      <div id="contenidoObjeto" class="hidden"></div>

      <div id="chat" class="chat-box hidden">
        <input type="text" id="pregunta" placeholder="Scrivi la tua domanda..." />
        <button id="btnInvia" onclick="enviarPregunta()">Invia domanda</button>
        <div id="respuestaChat" class="hidden"></div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <img src="logo1.png" alt="Logo instituzionale" class="footer-logo">
  </footer>

<script>
let contenido = {};
let contenidoCargado = false;
let escuchando = false;

// Configuraci√≥n global de Reconocimiento (Mejor compatibilidad m√≥vil)
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;

if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = "it-IT";
    recognition.continuous = false;
    recognition.interimResults = false;
}

/* ============================= CARGA JSON ============================= */
fetch("contenido.json")
  .then(res => res.json())
  .then(data => {
    contenido = data;
    contenidoCargado = true;
  })
  .catch(() => console.error("Errore caricamento JSON"));

/* ============================= UTILIDADES ============================= */
function activarBoton(btn) {
  document.querySelectorAll(".action-btn").forEach(b => b.classList.remove("active"));
  if (btn) btn.classList.add("active");
}

function mostrarSeccion(tipo) {
    const boxContenido = document.getElementById("contenidoObjeto");
    const boxChat = document.getElementById("chat");
    
    if (tipo === 'info') {
        boxContenido.classList.remove("hidden");
        boxChat.classList.add("hidden");
    } else {
        boxContenido.classList.add("hidden");
        boxChat.classList.remove("hidden");
    }
}

function mostrarContenido(texto) {
  mostrarSeccion('info');
  const box = document.getElementById("contenidoObjeto");
  box.innerHTML = texto || "<em>Contenuto non disponibile.</em>";
  box.classList.remove("fade-in");
  void box.offsetWidth; 
  box.classList.add("fade-in");
}

/* ============================= FUNCIONES BOTONES ============================= */
function mostrarTecnica(btn) { activarBoton(btn); mostrarContenido(contenido.tecniche); }
function mostrarSignificado(btn) { activarBoton(btn); mostrarContenido(contenido.significatoSimbolico); }
function mostrarProceso(btn) { activarBoton(btn); mostrarContenido(contenido.processo); }
function mostrarChat(btn) { activarBoton(btn); mostrarSeccion('chat'); }

/* ============================= VOZ (OPTIMIZADA) ============================= */
function hablar(testo) {
  if (!testo) return;
  window.speechSynthesis.cancel(); // Limpiar cola para iOS
  const speech = new SpeechSynthesisUtterance(testo);
  speech.lang = "it-IT";
  window.speechSynthesis.speak(speech);
}

function iniciarVoz(btn) {
  if (!SpeechRecognition) {
    alert("Il riconoscimento vocale non √® supportato su questo browser.");
    return;
  }
  
  activarBoton(btn);
  mostrarSeccion('chat');
  const respBox = document.getElementById("respuestaChat");
  respBox.classList.remove("hidden");
  respBox.innerHTML = "üé§ <strong>In ascolto...</strong> parli ora.";

  if (escuchando) return;

  recognition.onstart = () => { escuchando = true; };
  
  recognition.onresult = (event) => {
    const testo = event.results[0][0].transcript;
    document.getElementById("pregunta").value = testo;
    enviarPregunta();
  };

  recognition.onerror = (event) => {
    escuchando = false;
    respBox.innerHTML = "‚ùå Errore: " + event.error;
  };

  recognition.onend = () => { escuchando = false; };

  try {
    recognition.start();
  } catch (e) {
    recognition.stop();
  }
}

/* ============================= IA ============================= */
async function enviarPregunta() {
  const preguntaInput = document.getElementById("pregunta");
  const respuestaDiv = document.getElementById("respuestaChat");
  const pregunta = preguntaInput.value.trim();

  if (!pregunta || !contenidoCargado) return;

  respuestaDiv.classList.remove("hidden");
  respuestaDiv.innerHTML = "<em>Pensando...</em>";

  // Preparar contexto (resumido para estabilidad)
  const contexto = `Nome: ${contenido.nomeOggetto}. Storia: ${contenido.historia}. Tecniche: ${contenido.tecniche}. Simboli: ${contenido.significatoSimbolico}.`;

  try {
    const response = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pregunta, contenido: contexto })
    });

    const data = await response.json();
    if (data.respuesta) {
      respuestaDiv.innerHTML = `<strong>Risposta:</strong><br>${data.respuesta}`;
      hablar(data.respuesta);
    }
  } catch (err) {
    respuestaDiv.innerHTML = "‚ùå Errore nella connessione.";
  }
}
</script>
</body>
</html>
