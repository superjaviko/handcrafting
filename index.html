<!DOCTYPE html>
<html lang="es">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <div class="header">
  <img src="logo.png" alt="Logo Calabr√¨" class="logo">
  <h1>Oggetto fatto a mano</h1>
  </div>
  <title>HUMANMADE+</title>
  <style>
    * {
  box-sizing: border-box;
    }
   .header {
    text-align: center;
    margin-bottom: 20px;
    }
   .logo {
    max-width: 140px;
    width: 40%;
    height: auto;
    margin-bottom: 10px;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
    }
    h1 {
      text-align: center;
    }
    button {
      width: 100%;
      padding: 15px;
      margin: 8px 0;
      font-size: 16px;
      cursor: pointer;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, #444, #222);
      color: #fff;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.3s;
    }
    button:active {
    transform: scale(0.97);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2) inset;
    }
    button:hover {
    background: linear-gradient(135deg, #555, #333);
    }
    
    #respuesta {
      margin-top: 20px;
      padding: 15px;
      background-color: #eee;
      border-radius: 6px;
    }
    #contenidoObjeto,
    #respuestaChat {
    margin-top: 20px;
    padding: 16px;
    background: #f8f8f8;
    border-radius: 12px;
    font-size: 15px;
    line-height: 1.5;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .fade-in {
     animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
     }

    .hidden {
      display: none;
    }
    .chat input {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
      margin-bottom: 10px;
    }

     #btnInvia {
      width: 100%;
      padding: 12px;
      font-size: 1rem;
    }
    .btn-voice {
     background: linear-gradient(135deg, #8e44ad, #6c3483);
     }

    .btn-chat {
     background: linear-gradient(135deg, #2c3e50, #34495e);
    }
    .actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .action-btn {
      width: 100%;
      padding: 14px;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background: #ffffff;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s;
    }

    .action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .action-btn:active {
     transform: scale(0.97);
    }

   .action-btn.active {
     background: #eaeaea;
     font-weight: 600;
   }
  </style>
</head>
<body>

<div class="container">
  <h1>HUMANMADE+</h1>

  <p>
    Benvenuti. Questo articolo ha una storia speciale.
    Seleziona un'opzione per saperne di pi√π
  </p>

  <div class="actions">
  <button class="action-btn" onclick="activarBoton(this); mostrarHistoria()">üìú Storia dell‚Äôoggetto</button>
  <button class="action-btn" onclick="activarBoton(this); mostrarSignificado()">üé® Cosa significa?</button>
  <button class="action-btn" onclick="activarBoton(this); mostrarProceso()">üõ†Ô∏è Come √® stato creato?</button>

  <button class="action-btn btn-chat" onclick="activarBoton(this); mostrarChat()">üí¨ Chiedi all'IA</button>
  <button class="action-btn btn-voice" onclick="activarBoton(this); iniciarVoz()">üé§ Parlare</button>
  </div>


  <div id="contenidoObjeto" class="content">
    <em>Seleziona un'opzione per visualizzare le informazioni.</em>
  </div>

  <!-- CHAT -->
  <div id="chat" class="chat hidden">
    <input
      type="text"
      id="pregunta"
      placeholder="Scrivi la tua domanda su questo articolo..."
      oninput="mostrarInvia()"
    />

    <button id="btnInvia" onclick="enviarPregunta()">
      Invia domanda
    </button>

    <div id="respuestaChat" class="content">
      <em>Risposta.</em>
    </div>
  </div>
</div>


<script>
let contenido = {};
let contenidoCargado = false;

/* =============================
   CARGA Y VALIDACI√ìN DEL JSON
============================= */
fetch("contenido.json")
  .then(res => {
    if (!res.ok) throw new Error("No se pudo cargar contenido.json");
    return res.json();
  })
  .then(data => {
    contenido = data;
    contenidoCargado = true;
    console.log("‚úÖ Contenido cargado correctamente");
  })
  .catch(err => {
    console.error(err);
    alert("Errore nel contenuto dell‚Äôoggetto.");
  });

/* =============================
   CHAT VISUAL
============================= */
function ocultarChat() {
  document.getElementById("chat").classList.add("hidden");
}

function mostrarChat() {
  ocultarChat();
  document.getElementById("contenidoObjeto").innerHTML = "";
  document.getElementById("chat").classList.remove("hidden");
  document.getElementById("btnInvia").classList.remove("hidden");
  document.getElementById("pregunta").value = "";
  document.getElementById("respuestaChat").innerHTML = "<em>Risposta.</em>";
}

/* =============================
   CONTENIDO FIJO
============================= */

function mostrarContenido(texto) {
  const box = document.getElementById("contenidoObjeto");

  box.innerText = texto;

  // Reinicia animaci√≥n
  box.classList.remove("fade-in");
  void box.offsetWidth;
  box.classList.add("fade-in");
}
  
  
function mostrarHistoria(btn) {
  activarBoton(btn);
  ocultarChat();
  mostrarContenido(contenido.historia);
}

function mostrarSignificado(btn) {
  activarBoton(btn);
  ocultarChat();
  mostrarContenido(contenido.significatoSimbolico);
}

function mostrarProceso(btn) {
  activarBoton(btn);
  ocultarChat();
  mostrarContenido(contenido.processo);
}

function activarBoton(btn) {
  document.querySelectorAll(".action-btn").forEach(b =>
    b.classList.remove("active")
  );
  btn.classList.add("active");
}

/* =============================
   VOZ
============================= */
function hablar(testo) {
  const speech = new SpeechSynthesisUtterance(testo);
  speech.lang = "it-IT";
  window.speechSynthesis.speak(speech);
}

function iniciarVoz() {
  mostrarChat();
  document.getElementById("btnInvia").classList.add("hidden");

  const SpeechRecognition =
    window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    document.getElementById("contenidoObjeto").innerText =
      "Il riconoscimento vocale non √® disponibile.";
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = "it-IT";
  recognition.start();

  document.getElementById("contenidoObjeto").innerText =
    "üé§ In ascolto‚Ä¶";

  recognition.onresult = (event) => {
    document.getElementById("pregunta").value =
      event.results[0][0].transcript;
    enviarPregunta();
  };

  recognition.onerror = () => {
    document.getElementById("contenidoObjeto").innerText =
      "‚ùå Voce non riconosciuta.";
  };
}

/* =============================
   ENV√çO A IA (CORREGIDO)
============================= */
async function enviarPregunta() {
  if (!contenidoCargado) {
    alert("Il contenuto non √® ancora pronto. Riprova.");
    return;
  }

  const pregunta = document.getElementById("pregunta").value.trim();
  if (!pregunta) return;

  document.getElementById("respuestaChat").innerText = "Pensando‚Ä¶";

  const caratteristicheMaterialiTesto =
    contenido.caratteristicheMateriali
      ? `${contenido.caratteristicheMateriali.descrizione}
${(contenido.caratteristicheMateriali.fasi || []).join("\n")}
${contenido.caratteristicheMateriali.note || ""}`
      : "";

  const contesto = `
Nome oggetto: ${contenido.nomeOggetto}
Tipo oggetto: ${contenido.tipoOggetto}
Storia: ${contenido.historia}
Origine: ${contenido.origine}
Fonte: ${contenido.fonte}
Contesto: ${contenido.contesto}

Significato simbolico: ${contenido.significatoSimbolico}
Significato spirituale: ${contenido.significatoSpirituale}
Simboli: ${contenido.simboli}

Processo: ${contenido.processo}
Tecniche: ${contenido.tecniche}
Tempo: ${contenido.tempo}

Materiali: ${contenido.materiali}
Origine materiali: ${contenido.origineMateriali}

Caratteristiche materiali:
${caratteristicheMaterialiTesto}

Artigiano: ${contenido.artigiano}
Biografia:
${contenido.breveBiografia}

Funzione: ${contenido.funzione}
Importanza: ${contenido.importanza}
Curiosit√†: ${contenido.curiosita}
Raccomandazioni: ${contenido.raccomandazioni}
`;

  try {
    const response = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pregunta, contenido: contesto })
    });

    const data = await response.json();

    if (!data.respuesta) throw new Error("Risposta vuota");

    document.getElementById("respuestaChat").innerText = data.respuesta;
    hablar(data.respuesta);

  } catch (err) {
    console.error(err);
    document.getElementById("respuestaChat").innerText =
      "‚ùå Errore nella risposta dell‚Äôassistente.";
  }
}
</script>



</body>
</html>
